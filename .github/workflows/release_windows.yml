name: "Release on Windows x86_64"

# =============================================================================
# GitHub Actions Workflow: Build and Release HDF5 Static Libraries for Windows x86_64
#
# This workflow automates the build process for HDF5 static libraries on Windows,
# including C and C++ libraries with high-level APIs. The workflow uses MSVC
# compiler toolchain and produces static libraries (.lib files) suitable for
# linking with RadarSimCpp project.
#
# Workflow Triggers:
#   - push: When code is pushed to the main branch
#   - pull_request: When a PR targets the main branch
#
# Build Configuration:
#   - Platform: Windows x86_64
#   - Compiler: MSVC (Visual Studio toolchain)
#   - Build Type: Release (configurable via build.bat arguments)
#   - Output: Static libraries (.lib) and header files
#
# Artifacts Produced:
#   - Name: hdf5lib_win_x86_64
#   - Contents:
#       * ./output/lib_win_x86_64/    - Static library files (.lib)
#       * ./output/include/            - Common C/C++ header files
#       * ./output/include_win_x86_64/ - Platform-specific generated headers
#   - Retention: 14 days
#
# Libraries Built:
#   - libhdf5.lib        - Core HDF5 C library
#   - libhdf5_cpp.lib    - HDF5 C++ wrapper library
#   - libhdf5_hl.lib     - HDF5 High-Level C API
#   - libhdf5_hl_cpp.lib - HDF5 High-Level C++ API
# =============================================================================

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: "Build and Archive HDF5 Libraries"
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository with HDF5 source code
      # -----------------------------------------------------------------------
      # Retrieves the repository code including HDF5 source as a submodule.
      # The 'submodules: true' ensures HDF5 source code is properly fetched.
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          submodules: true

      # -----------------------------------------------------------------------
      # Step 2: Build HDF5 libraries using build script
      # -----------------------------------------------------------------------
      # Executes the build.bat script which:
      # 1. Checks for CMake availability and HDF5 source
      # 2. Configures CMake with appropriate HDF5 build options
      # 3. Compiles HDF5 libraries using MSVC in Release mode
      # 4. Organizes output into structured directories
      #
      # The script supports arguments: [clean] [debug]
      # Default behavior: Release build without cleaning
      - name: "Build HDF5 static libraries and headers"
        run: |
          .\build.bat

      # -----------------------------------------------------------------------
      # Step 3: Verify build artifacts and output structure
      # -----------------------------------------------------------------------
      # Performs validation checks to ensure build completed successfully:
      # 1. Confirms output directory exists
      # 2. Lists all library files for inspection
      # 3. Displays header files (first 20 for brevity)
      # 4. Verifies all 4 required libraries are present
      # 5. Fails the workflow if any library is missing
      #
      # This step helps catch build issues early before artifact upload.
      - name: "Verify build artifacts"
        shell: powershell
        run: |
          Write-Host "=== Verifying build output ==="
          
          # Check if output directory exists
          if (-not (Test-Path ".\output")) {
            Write-Error "ERROR: Output directory not found"
            exit 1
          }
          
          # Display library files
          Write-Host "`n=== Library files ==="
          Get-ChildItem -Path ".\output\lib_*" -Recurse -File
          
          # Display header files (limited to first 20)
          Write-Host "`n=== Header files ==="
          Get-ChildItem -Path ".\output\include" -File | Select-Object -First 20
          
          # Verify all required libraries are present
          $required_libs = @('libhdf5.lib', 'libhdf5_cpp.lib', 'libhdf5_hl.lib', 'libhdf5_hl_cpp.lib')
          foreach ($lib in $required_libs) {
            $found = Get-ChildItem -Path ".\output\lib_*" -Filter $lib -Recurse
            if (-not $found) {
              Write-Error "ERROR: Required library $lib not found"
              exit 1
            }
          }
          
          Write-Host "`n[SUCCESS] Build verification passed"

      # -----------------------------------------------------------------------
      # Step 4: Upload build artifacts for downstream use
      # -----------------------------------------------------------------------
      # Packages the build output as a GitHub Actions artifact:
      # - Artifact name: hdf5lib_win_x86_64
      # - Contents: Complete output directory with libs and headers
      # - Retention: 14 days (saves storage compared to 90-day default)
      # - Compression: Level 6 (balanced speed vs size)
      #
      # This artifact can be:
      # - Downloaded by developers for local use
      # - Used by other workflows/jobs as a dependency
      # - Attached to GitHub releases
      - name: "Archive built module"
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: hdf5lib_win_x86_64
          path: .\output
          retention-days: 14  # Keep artifact for 14 days (default is 90)
          compression-level: 6  # Balance between speed and size
