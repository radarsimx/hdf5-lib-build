name: "Release on Ubuntu x86_64"

# =============================================================================
# GitHub Actions Workflow: Build and Release HDF5 Static Libraries for Ubuntu 22.04 & 24.04 x86_64
#
# This workflow builds the HDF5 static libraries and headers for both Ubuntu 22.04 and 24.04
# using the provided build script, and uploads the resulting artifacts for use in downstream jobs or releases.
#
# Triggers:
#   - On push or pull request to the main branch
#
# Artifacts:
#   - hdf5lib_ubuntu_<version>_x86_64: Contains the built static libraries and headers for each Ubuntu version
# =============================================================================

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: "Build and Archive HDF5 Libraries (${{ matrix.ubuntu_version }})"
    runs-on: ${{ matrix.ubuntu_version }}
    strategy:
      matrix:
        include:
          - ubuntu_version: ubuntu-22.04
            c_compiler: gcc-11
            cxx_compiler: g++-11

    steps:
      # Checkout repository with submodules
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          submodules: true

      # (Optional) Cache build dependencies for faster builds
      # - name: "Cache build dependencies"
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.cache
      #     key: ${{ runner.os }}-hdf5lib-${{ hashFiles('**/CMakeLists.txt') }}

      # Build the project
      - name: "Build HDF5 static libraries and headers"
        env:
          CC: ${{ matrix.c_compiler }}
          CXX: ${{ matrix.cxx_compiler }}
        run: |
          sudo chown -R $USER:$USER /home/runner/work/hdf5-lib-build
          chmod +x build.sh
          ./build.sh

      # Upload the built libraries and headers as an artifact
      - name: "Archive built module"
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: hdf5lib_${{ matrix.ubuntu_version }}_x86_64
          path: ./release
          retention-days: 14  # Keep artifact for 14 days (default is 90)

      # (Optional) Add a step to verify the contents of the artifact
      # - name: "List artifact contents"
      #   run: |
      #     ls -l ./release
